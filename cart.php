<?php
// ====================================================================
// CART CONTROLLER LOGIC
// р╣Др╕Яр╕ер╣Мр╕Щр╕╡р╣Йр╕Ир╕░р╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Ир╕▒р╕Фр╕Бр╕▓р╕г Session р╣Бр╕ер╕░ Redirect р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕вр╕▒р╕Зр╕лр╕Щр╣Йр╕▓р╣Ар╕Фр╕┤р╕б
// ====================================================================

// 1. р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ Session р╣Бр╕ер╕░р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е (р╕Хр╣Йр╕нр╕Зр╕нр╕вр╕╣р╣Ир╕Ър╕Щр╕кр╕╕р╕Ф)
if (session_status() == PHP_SESSION_NONE) {
    session_start();    
}
require_once 'data.php'; 

// 2. р╕Бр╕│р╕лр╕Щр╕Фр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Ир╕░ Redirect р╕Бр╕ер╕▒р╕Ър╣Др╕Ы
// р╣Гр╕Кр╣Й HTTP Referer р╣Ар╕Юр╕╖р╣Ир╕нр╕лр╕▓р╕зр╣Ир╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕бр╕▓р╕Ир╕▓р╕Бр╕лр╕Щр╣Йр╕▓р╣Др╕лр╕Щ р╕лр╕гр╕╖р╕нр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╣Бр╕гр╕Бр╣Ар╕Ыр╣Зр╕Щр╕Др╣Ир╕▓р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
$redirect_url = $_SERVER['HTTP_REFERER'] ?? 'index.php';

// ============================================
// LOGIC: р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ (POST from product_detail.php)
// ============================================
if (isset($_POST['add_to_cart'])) {
    $product_id = (int)$_POST['product_id'];
    $quantity = (int)$_POST['quantity'];
    $size = $_POST['selected_size']; 

    // 2. ЁЯЯв р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Бр╕▓р╕гр╣Ар╕ер╕╖р╕нр╕Б Size р╕бр╕▓р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    if (!empty($size)) {
        
        // 3. ЁЯЯв р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ ID р╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╣Бр╕ер╕░ Size р╕Щр╕╡р╣Йр╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕лр╕гр╕╖р╕нр╕вр╕▒р╕З
        if (isset($_SESSION['cart'][$product_id][$size])) {
            // р╕Цр╣Йр╕▓р╕бр╕╡р╣Бр╕ер╣Йр╕з р╣Гр╕лр╣Йр╕Ър╕зр╕Бр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Юр╕┤р╣Ир╕б
            $_SESSION['cart'][$product_id][$size] += $quantity;
        } else {
            // р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡ р╣Гр╕лр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щр╕бр╕▓р╣Гр╕лр╕бр╣И
            $_SESSION['cart'][$product_id][$size] = $quantity;
        }
    }
    // р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╕Др╕╕р╕Ур╕нр╕▓р╕Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Юр╕┤р╣Ир╕б else р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕лр╕▓р╕Б $size р╕зр╣Ир╕▓р╕Зр╣Ар╕Ыр╕ер╣Ир╕▓
}

// ============================================
// LOGIC: р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓ (+ / -)
// ============================================
if (isset($_POST['update_quantity_action'])) {
    $product_id = (int)$_POST['product_id'];
    $size = $_POST['size']; // ЁЯЯв 1. р╕гр╕▒р╕Ър╕Др╣Ир╕▓ Size р╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╕бр╕▓р╕Ир╕▓р╕Б Form
    $action = $_POST['update_quantity_action']; 
    
    // ЁЯЯв 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ ID р╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╣Бр╕ер╕░ Size р╕Щр╕╡р╣Й р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓
    if (isset($_SESSION['cart'][$product_id][$size])) {
        $current_quantity = $_SESSION['cart'][$product_id][$size];
        
        if ($action === 'increase') {
            $_SESSION['cart'][$product_id][$size] = $current_quantity + 1;
        } elseif ($action === 'decrease') {
            $new_quantity = $current_quantity - 1;
            
            if ($new_quantity > 0) {
                $_SESSION['cart'][$product_id][$size] = $new_quantity;
            } else {
                // ЁЯЯв 3. р╕Цр╣Йр╕▓р╕Ир╕│р╕Щр╕зр╕Щр╕ер╕Фр╕ер╕Зр╕Ир╕Щр╣Ар╕лр╕ер╕╖р╕н 0 р╣Гр╕лр╣Йр╕ер╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕гр╕▓р╕вр╕Бр╕▓р╕г (size) р╕Щр╕▒р╣Йр╕Щ
                unset($_SESSION['cart'][$product_id][$size]);
                
                // ЁЯЯв 4. (р╣Бр╕Щр╕░р╕Щр╕│) р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Цр╣Йр╕▓ Product ID р╕Щр╕╡р╣Йр╣Др╕бр╣Ир╣Ар╕лр╕ер╕╖р╕н Size р╣Др╕лр╕Щр╣Бр╕ер╣Йр╕з р╕Бр╣Зр╣Гр╕лр╣Йр╕ер╕Ъ Product ID р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╣Ар╕ер╕в
                if (empty($_SESSION['cart'][$product_id])) {
                    unset($_SESSION['cart'][$product_id]);
                }
            }
        }
    }
}
// ============================================
// LOGIC: р╕ер╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╕ер╕░р╕гр╕▓р╕вр╕Бр╕▓р╕г (GET from Side Cart)
// ============================================
if (isset($_GET['action']) && $_GET['action'] == 'remove' && isset($_GET['id']) && isset($_GET['size'])) {
    $product_id_to_remove = (int)$_GET['id'];
    $size_to_remove = $_GET['size']; // ЁЯЯв р╕гр╕▒р╕Ър╕Др╣Ир╕▓ size р╕Чр╕╡р╣Ир╕Ир╕░р╕ер╕Ъ
    
    // 1. ЁЯЯв р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ ID р╕кр╕┤р╕Щр╕Др╣Йр╕▓ р╣Бр╕ер╕░ Size р╕Щр╕╡р╣Йр╕нр╕вр╕╣р╣Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    if (isset($_SESSION['cart'][$product_id_to_remove][$size_to_remove])) {
        // 2. ЁЯЯв р╕ер╕Ър╣Ар╕Йр╕Юр╕▓р╕░ Size р╕Щр╕▒р╣Йр╕Щр╕нр╕нр╕Бр╣Др╕Ы
        unset($_SESSION['cart'][$product_id_to_remove][$size_to_remove]);
        
        // 3. ЁЯЯв (р╣Бр╕Щр╕░р╕Щр╕│) р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Цр╣Йр╕▓ Product ID р╕Щр╕╡р╣Йр╣Др╕бр╣Ир╣Ар╕лр╕ер╕╖р╕н Size р╣Др╕лр╕Щр╣Бр╕ер╣Йр╕з р╕Бр╣Зр╣Гр╕лр╣Йр╕ер╕Ъ Product ID р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╣Ар╕ер╕в
        if (empty($_SESSION['cart'][$product_id_to_remove])) {
            unset($_SESSION['cart'][$product_id_to_remove]);
        }
    }
}

// ============================================
// LOGIC: р╕ер╣Йр╕▓р╕Зр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф (GET from Clear Cart button)
// ============================================
if (isset($_GET['action']) && $_GET['action'] == 'clear') {
    unset($_SESSION['cart']); 
}

// ЁЯЯв NEW LOGIC: р╣Ар╕Бр╣Зр╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕зр╣Ир╕▓ Side Cart р╕Др╕зр╕гр╕Цр╕╣р╕Бр╣Ар╕Ыр╕┤р╕Ф
$_SESSION['side_cart_open'] = true;

// 3. REDIRECT р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕вр╕▒р╕Зр╕лр╕Щр╣Йр╕▓р╣Ар╕Фр╕┤р╕бр╕лр╕ер╕▒р╕Зр╕Ир╕Ъ Logic р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
header('Location: ' . $redirect_url);
exit();
?>